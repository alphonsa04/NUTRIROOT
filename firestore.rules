rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user is an admin
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users Collection
    match /users/{userId} {
      // Users can read/write their own data
      // Admins can read/write all data
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Crops Collection (Readable by everyone, writable by admins)
    match /crops/{cropId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Soil Data Sub-collections (Readings)
    match /soilData/{userId}/readings/{readingId} {
      // Users can manage their own readings
      // Admins can manage all readings
      allow read, write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // Required for collectionGroup queries (e.g., Total Submissions)
    match /{path=**}/readings/{readingId} {
      allow read: if isAdmin();
    }

    // Contact Messages
    match /contactMessages/{messageId} {
      allow create: if true; // Anyone can send a message
      allow read, write: if isAdmin(); // Only admins can see/manage them
    }
  }
}
